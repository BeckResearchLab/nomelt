schema: '2.0'
stages:
  prepare_data:
    cmd: python scripts/prepare_data.py
    deps:
    - path: ./data/database.ddb
      hash: md5
      md5: b51482d0b753298b2bd522729dc69767
      size: 14074523648
    - path: ./nomelt/deduplication.py
      hash: md5
      md5: 43a77592878fbad6b852803f56c01114
      size: 13055
    - path: ./scripts/prepare_data.py
      hash: md5
      md5: 42a0d71ada4059542f939e480724d64f
      size: 8201
    params:
      params.yaml:
        data.dev_sample_data: false
        data.keep_only_extremes: false
        data.kgram: 4
        data.min_align_cov: 0.95
        data.min_temp_diff: 35.0
        data.min_thermo_temp: 65.0
        data.minhash_num_perm: 128
        data.minhash_threshold: 0.2
        data.test_size: 0.1
    outs:
    - path: ./data/data_metrics.yaml
      hash: md5
      md5: 1b565959d62d9f20dc402322cb702871
      size: 93
    - path: ./data/dataset/
      hash: md5
      md5: be46e5f5c141dbba9a0d37ab5e37ae60.dir
      size: 829652740
      nfiles: 11
  train:
    cmd: accelerate launch --config_file ./.config/accelerate/default_config.yaml
      scripts/train.py
    deps:
    - path: ./.config/accelerate/default_config.yaml
      hash: md5
      md5: d78cb00a386e0c5064e8a0eec14d6678
      size: 524
    - path: ./data/dataset/
      hash: md5
      md5: 6ea058879a12b471ded02fbd10b3fd9e.dir
      size: 5906034844
      nfiles: 18
    - path: ./scripts/train.py
      hash: md5
      md5: cf8239e8d457e8111577e9ae4fc7fb16
      size: 12135
    params:
      params.yaml:
        model.generation_max_length: 250
        model.model_hyperparams:
          dropout_rate: 0.1
          relative_attention_max_distance: 250
        model.pretrained_model: Rostlab/prot_t5_xl_uniref50
        model.task: translation
        training.additional_filters:
        - abs({seq_len_diff})/{meso_seq_len} < 0.08
        training.auto_find_batch_size: false
        training.bf16: true
        training.dev_sample_data:
        training.early_stopping: true
        training.early_stopping_patience: 4
        training.early_stopping_threshold: 0.1
        training.epochs: 3
        training.fp16: false
        training.gradient_accumulation: 2
        training.gradient_checkpointing: true
        training.keep_only_extremes: false
        training.label_smoothing_factor: 0.0
        training.learning_rate: 0.0001
        training.lr_scheduler_type: linear
        training.max_eval_examples: 10000
        training.optim: adamw_hf
        training.optim_args:
        training.per_device_batch_size: 140
        training.saves_per_epoch: 10
        training.warmup_ratio: 0.1
    outs:
    - path: ./data/nomelt-model/live/metrics.json
      hash: md5
      md5: 1bb360181f4f5e0953fb6f8162d3fba0
      size: 393
    - path: ./data/nomelt-model/live/plots/
      hash: md5
      md5: 07939accc8b6d545c65f08f002780011.dir
      size: 20617
      nfiles: 11
    - path: ./data/nomelt-model/live/report.md
      hash: md5
      md5: bad0a7484a13c623775ba37f6d6b032e
      size: 1281
    - path: ./data/nomelt-model/live/static/
      hash: md5
      md5: f1a9db415ade823229fd35e866885965.dir
      size: 231255
      nfiles: 11
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 44bd1f10d7bc1b9e50ac2f4bdc10e7f9.dir
      size: 321368839764
      nfiles: 257
  score_model:
    cmd: accelerate launch --config_file ./.config/accelerate/data_parallel_config.yaml
      scripts/score_model.py
    deps:
    - path: ./data/dataset/
      hash: md5
      md5: 9b6a544fa719bcd32f7ec0be763937bb.dir
      size: 833215556
      nfiles: 13
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 44bd1f10d7bc1b9e50ac2f4bdc10e7f9.dir
      size: 321368839764
      nfiles: 257
    - path: ./scripts/score_model.py
      hash: md5
      md5: 0afcb186cf8d1c120771a301c6382041
      size: 9346
    params:
      params.yaml:
        model.generation_max_length: 250
        model.generation_num_beams: 10
    outs:
    - path: ./data/nomelt-model/test_metrics.yaml
      hash: md5
      md5: 3696b43e94a05ae22e74272263269583
      size: 225
  make_predictions:
    cmd: accelerate launch --config_file ./.config/accelerate/data_parallel_config.yaml
      scripts/make_predictions.py
    deps:
    - path: ./data/dataset/
      hash: md5
      md5: 61b486888c9596ee59cd58625ca98666.dir
      size: 846265188
      nfiles: 13
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 44bd1f10d7bc1b9e50ac2f4bdc10e7f9.dir
      size: 321368839764
      nfiles: 257
    - path: ./scripts/make_predictions.py
      hash: md5
      md5: 98181c8b634254dffed362691be01db3
      size: 9541
    params:
      params.yaml:
        model.generation_max_length: 250
        model.generation_num_beams: 10
    outs:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: df3499c8038881bcfe0b44a8928ac98d
      size: 3831638
  score_predictions:
    cmd: python scripts/score_predictions.py
    deps:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: df3499c8038881bcfe0b44a8928ac98d
      size: 3831638
    - path: ./scripts/score_predictions.py
      hash: md5
      md5: 72f8c9d08f4dc9af8ec10fb9c7843cec
      size: 3799
    outs:
    - path: ./data/nomelt-model/test_scores.json
      hash: md5
      md5: b187d552e09de5b74389d538cc7a2b40
      size: 278
  translate_enh1:
    cmd: python scripts/translate_enh1.py
    deps:
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 44bd1f10d7bc1b9e50ac2f4bdc10e7f9.dir
      size: 321368839764
      nfiles: 257
    - path: ./scripts/translate_enh1.py
      hash: md5
      md5: 5487731ffece44c0934159eec79f3815
      size: 1042
    params:
      params.yaml:
        model.generation_max_length: 250
        model.generation_num_beams: 10
    outs:
    - path: ./data/enh/translate_enh1.json
      hash: md5
      md5: 2b118641cd5582bfa16d743563357612
      size: 170
  optimize_enh1:
    cmd: python scripts/optimize_enh1.py
    deps:
    - path: ./data/enh/translate_enh1.json
      hash: md5
      md5: 66613740686cb02983ea956f9498558c
      size: 166
    - path: ./scripts/optimize_enh1.py
      hash: md5
      md5: 93a1320dce3e4f86b2a1f82bcf600377
      size: 4336
    params:
      params.yaml:
        optimize.cut_tails:
        optimize.direction: minimize
        optimize.estimator: ESMFoldDGEstimator
        optimize.gap_compressed_mutations: true
        optimize.gapextend: -1
        optimize.gapopen: -4
        optimize.match_score: 1
        optimize.matrix: BLOSUM62
        optimize.mismatch_score: -1
        optimize.n_trials: 100
        optimize.penalize_end_gaps: false
        optimize.sampler: NSGAIISampler
    outs:
    - path: ./data/enh/optimize_enh1/
      hash: md5
      md5: 4e99caa42f94cae558692834f437de71.dir
      size: 3758949
      nfiles: 85
    - path: ./data/enh/optimize_enh1_results.json
      hash: md5
      md5: 796d21ebc6f54cc11c16a333f9b00ef8
      size: 22970
    - path: ./data/enh/optimize_enh1_trials.csv
      hash: md5
      md5: 3c7b252c22c4b277e0d1d846f5a0cdee
      size: 19347
  estimate_trans_energy_enh1:
    cmd: python scripts/estimate_trans_energy_enh1.py
    deps:
    - path: ./.config/af_singularity_config.yaml
      hash: md5
      md5: 54b4d2b353c97261fdc4a16dce408154
      size: 276
    - path: ./data/enh/translate_enh1.json
      hash: md5
      md5: 2b118641cd5582bfa16d743563357612
      size: 170
    - path: scripts/estimate_trans_energy_enh1.py
      hash: md5
      md5: 26e8c5a3dab1ed6d27e390492d907fdd
      size: 1353
    params:
      params.yaml:
        optimize.estimator: mAFminDGEstimator
        optimize.estimator_args:
          af_params: ./.config/af_singularity_config.yaml
          use_relaxed: false
          num_replicates: 25
          fix_msas: true
    outs:
    - path: ./data/enh/initial_estimate/
      hash: md5
      md5: 5767fecc932956fc42a4c331efb08850.dir
      size: 15859178
      nfiles: 64
    - path: ./data/enh/translated_energy_enh1.json
      hash: md5
      md5: ee2dd680f51412bdba441ba2ae74d09b
      size: 52
