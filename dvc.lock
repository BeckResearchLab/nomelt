schema: '2.0'
stages:
  prepare_data:
    cmd: python scripts/prepare_data.py
    deps:
    - path: ./data/database.ddb
      hash: md5
      md5: b51482d0b753298b2bd522729dc69767
      size: 14074523648
    - path: ./nomelt/deduplication.py
      hash: md5
      md5: 43a77592878fbad6b852803f56c01114
      size: 13055
    - path: ./scripts/prepare_data.py
      hash: md5
      md5: ddd612e1152c723bbf5e745aa153b4d5
      size: 9841
    params:
      params.yaml:
        data.dev_sample_data: false
        data.min_align_cov: 0.95
        data.min_temp_diff: 35.0
        data.min_thermo_temp: 65.0
        data.mmseq_params:
          coverage: 0.8
          min-seq-id: 0.2
          cluster-mode: 1
          similarity-type: 1
          e: 0.001
        data.test_size: 0.1
    outs:
    - path: ./data/data_metrics.yaml
      hash: md5
      md5: 2b73ec17b7e3e97a4b0db721ebb42718
      size: 92
    - path: ./data/dataset/
      hash: md5
      md5: 694dcc3c2816dab11e4ee6c29976d0a5.dir
      size: 822169547
      nfiles: 11
  blast_test_train:
    cmd: python scripts/blast_test_train.py
    deps:
    - path: ./data/dataset/
      hash: md5
      md5: 694dcc3c2816dab11e4ee6c29976d0a5.dir
      size: 822169547
      nfiles: 11
    - path: ./scripts/blast_test_train.py
      hash: md5
      md5: 50ddd31336baf785e8bef3f6b66a3124
      size: 3108
    outs:
    - path: ./data/plots/test_train_blast_hist.png
      hash: md5
      md5: c2143e5887a3daf540c72f25e995cc9a
      size: 135130
    - path: ./data/test_train_blast_metrics.json
      hash: md5
      md5: cd1cab15c21d528c6f1f04bb69f26daf
      size: 609
  train:
    cmd: accelerate launch --config_file ./.config/accelerate/default_config.yaml
      scripts/train.py
    deps:
    - path: ./.config/accelerate/default_config.yaml
      hash: md5
      md5: d78cb00a386e0c5064e8a0eec14d6678
      size: 524
    - path: ./data/dataset/
      hash: md5
      md5: 4c07792589b0687cec4bba8d16b60940.dir
      size: 37002068323
      nfiles: 43
    - path: ./scripts/train.py
      hash: md5
      md5: 21dbaa8087633cf210e3cd0da96231a1
      size: 14291
    params:
      params.yaml:
        model.generation_max_length: 250
        model.model_hyperparams:
          dropout_rate: 0.1
          relative_attention_max_distance: 250
        model.pretrained_model: Rostlab/prot_t5_xl_uniref50
        model.task: translation
        training.additional_filters:
        - abs({seq_len_diff})/{meso_seq_len} < 0.08
        training.auto_find_batch_size: false
        training.bf16: true
        training.dev_sample_data: false
        training.early_stopping: true
        training.early_stopping_patience: 4
        training.early_stopping_threshold: 0.01
        training.epochs: 3
        training.evals_per_epoch: 30
        training.evals_per_save: 3
        training.fp16: false
        training.gradient_accumulation: 2
        training.gradient_checkpointing: true
        training.label_smoothing_factor: 0.01
        training.learning_rate: 0.0001
        training.lr_scheduler_type: linear
        training.max_eval_examples: 5000
        training.optim: adamw_hf
        training.optim_args:
        training.per_device_batch_size: 20
        training.reweight: true
        training.warmup_ratio: 0.1
    outs:
    - path: ./data/nomelt-model/live/metrics.json
      hash: md5
      md5: 2a8125b2971384039e6a00b5031622ae
      size: 393
    - path: ./data/nomelt-model/live/plots/
      hash: md5
      md5: d208183577148c93ae6444da0d339863.dir
      size: 82308
      nfiles: 11
    - path: ./data/nomelt-model/live/report.md
      hash: md5
      md5: cd74e483669710f04e79659404bf2fca
      size: 1281
    - path: ./data/nomelt-model/live/static/
      hash: md5
      md5: f895e3866ca947cfcb192fe1c4dfb647.dir
      size: 241759
      nfiles: 11
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 0a7e1478be1ef88037da4c451afd3c13.dir
      size: 124037480969
      nfiles: 107
  make_predictions:
    cmd: accelerate launch --config_file ./.config/accelerate/data_parallel_config.yaml
      scripts/make_predictions.py
    deps:
    - path: ./data/dataset/
      hash: md5
      md5: 81a2c54576322e8d5998db00849ff6e0.dir
      size: 830484443
      nfiles: 18
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 0a7e1478be1ef88037da4c451afd3c13.dir
      size: 124037480969
      nfiles: 107
    - path: ./scripts/make_predictions.py
      hash: md5
      md5: 200a2ca596f6a0a810b14bea3a78b05f
      size: 8200
    params:
      params.yaml:
        model.generation_max_length: 250
        model.generation_num_beams: 10
    outs:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: 1272601acd644ec6b0ba762df6f05ace
      size: 214718
  score_predictions:
    cmd: python scripts/score_predictions.py
    deps:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: 1272601acd644ec6b0ba762df6f05ace
      size: 214718
    - path: ./scripts/score_predictions.py
      hash: md5
      md5: ab43e910ba7db780115e01f82834c1a8
      size: 3853
    outs:
    - path: ./data/nomelt-model/test_scores.json
      hash: md5
      md5: 03b68b252722b082bc4f3f120c17eb92
      size: 290
  compare_sequence_alignment:
    cmd: python scripts/compare_sequence_alignment.py
    deps:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: 1272601acd644ec6b0ba762df6f05ace
      size: 214718
    - path: ./scripts/compare_sequence_alignment.py
      hash: md5
      md5: 78aa3fd9a637f6b55a83c940e1bca96f
      size: 2851
    outs:
    - path: ./data/nomelt-model/test_predictions_aligned_results.json
      hash: md5
      md5: d2de03e6e141ad315761a1133a35717b
      size: 749515
  natural_diversity_entropy:
    cmd: python scripts/proof_of_principle/natural_diversity_entropy.py
    deps:
    - path: ./data/dataset
      hash: md5
      md5: 7415c0cd0df9964297d1b61df5341438.dir
      size: 830493755
      nfiles: 19
    - path: ./scripts/proof_of_principle/natural_diversity_entropy.py
      hash: md5
      md5: c91a2e6c91b0c330a6ee027f065b7e66
      size: 5063
    outs:
    - path: ./data/proof_of_principle/natural_diversity_entropy.json
      hash: md5
      md5: a32d29514079094dc4d1f6b8325739f2
      size: 37
