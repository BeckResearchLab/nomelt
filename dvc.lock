schema: '2.0'
stages:
  prepare_data:
    cmd: python scripts/prepare_data.py
    deps:
    - path: ./data/database.ddb
      hash: md5
      md5: b51482d0b753298b2bd522729dc69767
      size: 14074523648
    - path: ./nomelt/deduplication.py
      hash: md5
      md5: 43a77592878fbad6b852803f56c01114
      size: 13055
    - path: ./scripts/prepare_data.py
      hash: md5
      md5: 7f2dcba728f8cf334b07ea01eb1f01ce
      size: 8930
    params:
      params.yaml:
        data.dev_sample_data: false
        data.min_align_cov: 0.95
        data.min_temp_diff: 35.0
        data.min_thermo_temp: 65.0
        data.mmseq_params:
          coverage: 0.9
          min-seq-id: 0.3
          cluster-mode: 1
        data.test_size: 0.1
    outs:
    - path: ./data/data_metrics.yaml
      hash: md5
      md5: 1e5b784f7a8fb544a6f6c50975f72858
      size: 92
    - path: ./data/dataset/
      hash: md5
      md5: 6af7a1202a6f0151157c6e9b95691aa4.dir
      size: 809056334
      nfiles: 11
  train:
    cmd: accelerate launch --config_file ./.config/accelerate/default_config.yaml
      scripts/train.py
    deps:
    - path: ./.config/accelerate/default_config.yaml
      hash: md5
      md5: d78cb00a386e0c5064e8a0eec14d6678
      size: 524
    - path: ./data/dataset/
      hash: md5
      md5: d8c06c1c94279fb6ed3a5a4dba992507.dir
      size: 890719503
      nfiles: 36
    - path: ./scripts/train.py
      hash: md5
      md5: 49407d123756368f6dd19f89f5daafe0
      size: 13924
    params:
      params.yaml:
        model.generation_max_length: 250
        model.model_hyperparams:
          dropout_rate: 0.1
          relative_attention_max_distance: 250
        model.pretrained_model: Rostlab/prot_t5_xl_uniref50
        model.task: translation
        training.additional_filters:
        - abs({seq_len_diff})/{meso_seq_len} < 0.08
        training.auto_find_batch_size: false
        training.bf16: true
        training.dev_sample_data: 1000
        training.early_stopping: false
        training.early_stopping_patience: 4
        training.early_stopping_threshold: 0.1
        training.epochs: 3
        training.fp16: false
        training.gradient_accumulation: 2
        training.gradient_checkpointing: true
        training.label_smoothing_factor: 0.01
        training.learning_rate: 0.0001
        training.lr_scheduler_type: linear
        training.max_eval_examples: 5000
        training.optim: adamw_hf
        training.optim_args:
        training.per_device_batch_size: 20
        training.reweight: true
        training.saves_per_epoch:
        training.warmup_ratio: 0.1
    outs:
    - path: ./data/nomelt-model/live/metrics.json
      hash: md5
      md5: 6c378afaeaaa390f23772fa0d32c2322
      size: 227
    - path: ./data/nomelt-model/live/plots/
      hash: md5
      md5: e81aec0ddb5521f42e7496c2fe23f047.dir
      size: 481
      nfiles: 7
    - path: ./data/nomelt-model/live/report.md
      hash: md5
      md5: a0662ada01e362113b23067516c714ce
      size: 796
    - path: ./data/nomelt-model/live/static/
      hash: md5
      md5: 5e2ae1942104d5defb356f07f44d021a.dir
      size: 124223
      nfiles: 7
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: cb83b63b261325b60cc2e8515d9f5c01.dir
      size: 321368861341
      nfiles: 258
  score_model:
    cmd: accelerate launch --config_file ./.config/accelerate/data_parallel_config.yaml
      scripts/score_model.py
    deps:
    - path: ./data/dataset/
      hash: md5
      md5: 9b6a544fa719bcd32f7ec0be763937bb.dir
      size: 833215556
      nfiles: 13
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 44bd1f10d7bc1b9e50ac2f4bdc10e7f9.dir
      size: 321368839764
      nfiles: 257
    - path: ./scripts/score_model.py
      hash: md5
      md5: 0afcb186cf8d1c120771a301c6382041
      size: 9346
    params:
      params.yaml:
        model.generation_max_length: 250
        model.generation_num_beams: 10
    outs:
    - path: ./data/nomelt-model/test_metrics.yaml
      hash: md5
      md5: 3696b43e94a05ae22e74272263269583
      size: 225
  make_predictions:
    cmd: accelerate launch --config_file ./.config/accelerate/data_parallel_config.yaml
      scripts/make_predictions.py
    deps:
    - path: ./data/dataset/
      hash: md5
      md5: c3ecd0b475db433225b23e2df0ab64e4.dir
      size: 829966708
      nfiles: 14
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 44bd1f10d7bc1b9e50ac2f4bdc10e7f9.dir
      size: 321368839764
      nfiles: 257
    - path: ./scripts/make_predictions.py
      hash: md5
      md5: 18cf21ad5614fb9ae934ad9fe68a6dc1
      size: 8242
    params:
      params.yaml:
        model.generation_max_length: 250
        model.generation_num_beams: 10
    outs:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: 737859368ef694edaf70544e9c87a65a
      size: 1155256
  score_predictions:
    cmd: python scripts/score_predictions.py
    deps:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: 737859368ef694edaf70544e9c87a65a
      size: 1155256
    - path: ./scripts/score_predictions.py
      hash: md5
      md5: a1e9541da0a4b2cb9fdb6b2229a2355e
      size: 3799
    outs:
    - path: ./data/nomelt-model/test_scores.json
      hash: md5
      md5: b187d552e09de5b74389d538cc7a2b40
      size: 278
  translate_enh1:
    cmd: python scripts/translate_enh1.py
    deps:
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 44bd1f10d7bc1b9e50ac2f4bdc10e7f9.dir
      size: 321368839764
      nfiles: 257
    - path: ./scripts/translate_enh1.py
      hash: md5
      md5: 5487731ffece44c0934159eec79f3815
      size: 1042
    params:
      params.yaml:
        model.generation_max_length: 250
        model.generation_num_beams: 10
    outs:
    - path: ./data/enh/translate_enh1.json
      hash: md5
      md5: 2b118641cd5582bfa16d743563357612
      size: 170
  optimize_enh1:
    cmd: python scripts/optimize_enh1.py
    deps:
    - path: ./data/enh/translate_enh1.json
      hash: md5
      md5: 2b118641cd5582bfa16d743563357612
      size: 170
    - path: ./scripts/optimize_enh1.py
      hash: md5
      md5: 958cf20a9933f0b96e9bf0f35724bd49
      size: 4583
    params:
      params.yaml:
        optimize.cut_tails:
        optimize.direction: minimize
        optimize.estimator: mAFminDGEstimator
        optimize.estimator_args:
          af_params: ./.config/af_singularity_config.yaml
          use_relaxed: false
          num_replicates: 25
          fix_msas: true
          residue_length_norm: true
        optimize.gap_compressed_mutations: true
        optimize.gapextend: -1
        optimize.gapopen: -4
        optimize.match_score: 1
        optimize.matrix: BLOSUM62
        optimize.mismatch_score: -1
        optimize.n_trials: 100
        optimize.optuna_overwrite: true
        optimize.penalize_end_gaps: false
        optimize.sampler: NSGAIISampler
        optimize.sampler_args:
          population_size: 10
    outs:
    - path: ./data/enh/optimize_enh1/
      hash: md5
      md5: b72de91049cc3dd3727d3fd3cbfba83e.dir
      size: 3199195000
      nfiles: 8440
    - path: ./data/enh/optimize_enh1_results.json
      hash: md5
      md5: b8efa48bb1ea05ecf5a560d6815d08ec
      size: 261
    - path: ./data/enh/optimize_enh1_trials.csv
      hash: md5
      md5: ccf9a62957a845b9e535631343b9e635
      size: 89352
  estimate_trans_energy_enh1:
    cmd: python scripts/estimate_trans_energy_enh1.py
    deps:
    - path: ./.config/af_singularity_config.yaml
      hash: md5
      md5: 6ff0e462bb3c6efc4c9b314193e06468
      size: 275
    - path: ./data/enh/translate_enh1.json
      hash: md5
      md5: 2b118641cd5582bfa16d743563357612
      size: 170
    - path: scripts/estimate_trans_energy_enh1.py
      hash: md5
      md5: b7a6656c4c6fabdde84c79920da0bca9
      size: 1382
    params:
      params.yaml:
        optimize.estimator: mAFminDGEstimator
        optimize.estimator_args:
          af_params: ./.config/af_singularity_config.yaml
          use_relaxed: false
          num_replicates: 25
          fix_msas: true
          residue_length_norm: true
    outs:
    - path: ./data/enh/initial_estimate/
      hash: md5
      md5: c9c6c008e00f198cab04af3b311ee075.dir
      size: 15859176
      nfiles: 64
    - path: ./data/enh/translated_energy_enh1.json
      hash: md5
      md5: 2a4bc8d1786a7ebb379c14915363c8af
      size: 54
  data_estimator_distribution:
    cmd: python scripts/data_estimator_distribution.py
    deps:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: 737859368ef694edaf70544e9c87a65a
      size: 1155256
    - path: ./scripts/data_estimator_distribution.py
      hash: md5
      md5: df5dbeedda8b207fc24283fd64b06977
      size: 4896
    outs:
    - path: ./data/thermo_gen_estimated.json
      hash: md5
      md5: 3a852210f275025ef7264f3303b24df6
      size: 12258
  enh1_vs_consensus_in_silico_estimator:
    cmd: python scripts/proof_of_principle/enh1_vs_consensus_in_silico_estimator.py
    deps:
    - path: ./scripts/proof_of_principle/enh1_vs_consensus_in_silico_estimator.py
      hash: md5
      md5: bb39bfb33ca6535dd0f1dbcd7d051152
      size: 1366
    outs:
    - path: ./data/proof_of_principle/enh1_vs_consensus_in_silico_estimator_out.json
      hash: md5
      md5: 492c3f24b0782ead2c79a1d715c5dfea
      size: 112
  enh1_vary_mutations:
    cmd: python scripts/proof_of_principle/enh1_vary_mutations.py
    deps:
    - path: ./scripts/proof_of_principle/enh1_vary_mutations.py
      hash: md5
      md5: e83bdf5eb5fd0d16e3b567b87195dbe4
      size: 1646
    outs:
    - path: ./data/proof_of_principle/vary_mutations.json
      hash: md5
      md5: 20b6bb7e29f92a4e74ae37ef58e3009c
      size: 227
  enh1_consensus_optimize:
    cmd: python scripts/proof_of_principle/enh1_consensus_optimize.py
    deps:
    - path: ./scripts/proof_of_principle/enh1_consensus_optimize.py
      hash: md5
      md5: eeca826940098aeb6d0c44d58a42660c
      size: 4538
    outs:
    - path: ./data/proof_of_principle/optimize_enh1_cons_results.json
      hash: md5
      md5: c2c7b798834fed24fc37af70d07e8c13
      size: 255
    - path: ./data/proof_of_principle/optimize_enh1_cons_trials.csv
      hash: md5
      md5: f50ea434e09ac0196e8e6701fc3892cc
      size: 90406
  compute_test_embeddings:
    cmd: python scripts/compute_test_embeddings.py
    deps:
    - path: ./data/dataset/
      hash: md5
      md5: c3ecd0b475db433225b23e2df0ab64e4.dir
      size: 829966708
      nfiles: 14
    - path: ./data/nomelt-model/model/
      hash: md5
      md5: 44bd1f10d7bc1b9e50ac2f4bdc10e7f9.dir
      size: 321368839764
      nfiles: 257
    - path: ./scripts/compute_test_embeddings.py
      hash: md5
      md5: 33cc8fbe74f9238ed4ce6e6eb91b73ae
      size: 5725
  enh1_vs_consensus_docking_score:
    cmd: python scripts/proof_of_principle/enh1_vs_consensus_docking_score.py
    deps:
    - path: ./scripts/proof_of_principle/enh1_vs_consensus_docking_score.py
      hash: md5
      md5: 3706409c13ccbb0525142bc9a713938c
      size: 2148
    outs:
    - path: ./data/proof_of_principle/enh1_vs_consensus_dna_binding.json
      hash: md5
      md5: af24131eab9b8a7227ec8d622f4d3b7d
      size: 344
  enh1_random_opt:
    cmd: python scripts/proof_of_principle/enh1_random_opt.py
    deps:
    - path: ./scripts/proof_of_principle/enh1_random_opt.py
      hash: md5
      md5: e53c4f08416579acf3e90aeadfabaad1
      size: 5285
    outs:
    - path: ./data/proof_of_principle/optimize_enh1_rand_trials.csv
      hash: md5
      md5: 9ea9f045a60bf58ac04cc0d47785d093
      size: 75867
    - path: ./data/proof_of_principle/optimize_enh1_random_results.json
      hash: md5
      md5: b2828d95e87517ad2dc22038189458be
      size: 252
  natural_diversity_entropy:
    cmd: python scripts/proof_of_principle/natural_diversity_entropy.py
    deps:
    - path: ./data/dataset
      hash: md5
      md5: c3ecd0b475db433225b23e2df0ab64e4.dir
      size: 829966708
      nfiles: 14
    - path: ./scripts/proof_of_principle/natural_diversity_entropy.py
      hash: md5
      md5: 0ed48ea4bd3e02b45d464788e6138d6a
      size: 4832
    outs:
    - path: ./data/proof_of_principle/natural_diversity_entropy.json
      hash: md5
      md5: 2688a7b8fc6e3f9df885afca2c0bc68e
      size: 37
  compare_sequence_alignment:
    cmd: python scripts/compare_sequence_alignment.py
    deps:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: 737859368ef694edaf70544e9c87a65a
      size: 1155256
    - path: ./scripts/compare_sequence_alignment.py
      hash: md5
      md5: a842c41c68a9b83b3efc32dab1e91bae
      size: 2769
    outs:
    - path: ./data/nomelt-model/sequence_alignment.csv
      hash: md5
      md5: b13f4e97d6adb7264e78c5b4c8891253
      size: 537671
  compare_structure:
    cmd: python scripts/compare_structure.py
    deps:
    - path: ./data/nomelt-model/predictions.tsv
      hash: md5
      md5: 737859368ef694edaf70544e9c87a65a
      size: 1155256
    - path: ./scripts/compare_structure.py
      hash: md5
      md5: dba7236a1abaa1022269338f8ed493d4
      size: 10433
    outs:
    - path: ./data/nomelt-model/structure_metrics.json
      hash: md5
      md5: 8caaf7e98cce76eba0fbd7ee6f96bf8c
      size: 115
  enh1_in_training_set:
    cmd: python scripts/proof_of_principle/enh1_check_training_set.py
    deps:
    - path: ./scripts/proof_of_principle/enh1_check_training_set.py
      hash: md5
      md5: 1aa71410ba4633683710a6367bec4911
      size: 678
    outs:
    - path: ./data/enh/training_data_homologs.json
      hash: md5
      md5: f93e89dba11ccadc4caefb3b390b2ba0
      size: 73
